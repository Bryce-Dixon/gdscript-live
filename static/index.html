<!DOCTYPE html>
<html>
<head>
    <title>GDScript.Live</title>
    <style>
    </style>
    <link rel="stylesheet" href="/static/main.css" />
    <link rel="stylesheet" href="/static/colors.css" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
        crossorigin="anonymous"></script>
   <script src="https://unpkg.com/monaco-editor@latest/min/vs/loader.js"></script> 
</head>
<body>
    <div class="header">
        <div class="flex-h">
            <img src="/static/gdscript-live.icon.png" class="icon" />
            <div class="flex-v no-margin" style="flex: 1 1 auto;">
                <div class="flex-h" style="margin-left: 0; margin-right: auto; column-gap: 1em;">
                    <h1 class="no-margin">GDScript.Live</h1>
                    <h2><a href="https://docs.godotengine.org/en/latest/tutorials/scripting/gdscript/gdscript_basics.html" target="_blank">Docs</a></h2>
                    <h2><a href="https://github.com/BtheDestroyer/gdscript-live/tree/node" target="_blank">Source</a></h2>
                </div>
                <hr/>
                <div class="flex-v no-margin">
                    <p>Currently under development</p>
                    <p>GDScript.Live &copy; Bryce Dixon, 2024</p>
                    <p>Godot Engine &copy; Juan Linietsky, Ariel Manzur and contributors</p>
                </div>
            </div>
        </div>
    </div>
    <div class="flex-h" id="main-split">
        <div id="code-editor" class="split-section"></div>
        <div class="handle">
            <div class="handle-dot"></div>
            <div class="handle-dot"></div>
            <div class="handle-dot"></div>
        </div>
        <div id="control-panel" class="flex-v split-section">
            <div class="flex-h no-margin">
                <label for="godot-version">Godot Version:</label>
                <select name="godot-version" id="godot-version">
                </select>
                <input id="run-button" type="button" value="Run" onclick="runScript()" />
            </div>
            <div id="script-results" class="flex-v no-margin">
                <label for="stdout">stdout:</label><br/>
                <textarea id="stdout" name="stdout" readonly></textarea><br/>
                <label for="stderr">stderr:</label><br/>
                <textarea id="stderr" name="stderr" readonly></textarea>
            </div>
        </div>
    </div>

    <script>
        require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@latest/min/vs' }});
        window.MonacoEnvironment = { getWorkerUrl: () => proxy };

        const proxy = URL.createObjectURL(new Blob([`
            self.MonacoEnvironment = {
                baseUrl: 'https://unpkg.com/monaco-editor@latest/min/'
            };
            importScripts('https://unpkg.com/monaco-editor@latest/min/vs/base/worker/workerMain.js');
        `], { type: 'text/javascript' }));

        var editor;
        require(["vs/editor/editor.main"], function () {
            monaco.languages.register({ id: "gdscript" });
            monaco.languages.setMonarchTokensProvider("gdscript", {
                keywords: [
                    "if", "elif", "else",
                    "for", "while", "match",
                    "break", "continue", "pass",
                    "return", "class", "class_name",
                    "extends", "is", "in", "as",
                    "self", "super", "signal", "func",
                    "static", "const", "enum", "var",
                    "breakpoint", "preload", "await",
                    "yield", "assert", "void",
                    "PI", "TAU", "INF", "NAN"
                ],
                tokenizer: {
                    root: [
                        [/@?[a-zA-Z][\w$]*/, {
                            cases: {
                                "@keywords": "keyword",
                                "@default": "variable"
                            }
                        }],
                        [/[&^]?".*?"/, "string"],
                        [/#/, "comment"]
                    ]
                }
            });
            editor = monaco.editor.create(document.getElementById('code-editor'), {
                value: [
                    'func main():',
                    '\tprint("Hello world!")',
                    ''
                ].join('\n'),
                language: 'gdscript',
                theme: 'vs-dark',
                automaticLayout: true
            });
        });
    </script>
    <script>
        var handle_ratio = 0.5;
        var horizontal_layout = true;
        function onResize() {
            const aspect = window.innerWidth / window.innerHeight;
            if (aspect > 1.5)
            {
                $("#main-split.flex-h>.handle").css("width", "");
                horizontal_layout = true
            }
            else if (aspect < 0.6)
            {
                $("#main-split.flex-v>.handle").css("height", "");
                horizontal_layout = false;
            }
            const split_height = $("#main-split").height();
            const split_width = window.innerWidth;
            if (horizontal_layout)
            {
                $(".flex-h>#code-editor").width((window.innerWidth - 12) * handle_ratio);
            }
            else
            {
                $(".flex-v>#code-editor").height((split_height - 12) * handle_ratio);
            }
        }
        $(window).resize(onResize);
        onResize();

        async function updateVersionList() {
            try
            {
                const response = await fetch("/api/versions");
                if (!response.ok)
                {
                    throw new Error(`Response status: ${response.status}`);
                }
                const json = await response.json();
                const select = $("select#godot-version");
                select.empty();
                for (const version of json["versions"])
                {
                    select.append(`<option value="${version}">${version}</option>`);
                }
            }
            catch (error)
            {
                console.error(error);
            }
        }
        updateVersionList();

        async function runScript() {
            $("#stdout, #stderr").html("Running script...");
            try
            {
                const select = document.getElementById("godot-version");
                const response = await fetch(`/api/run?script=${btoa(editor.getValue())}&godot_version=${select.value}`);
                if (!response.ok)
                {
                    throw new Error(`Response status: ${response.status}`);
                }
                const json = await response.json();
                $("#stdout").html(json["stdout"]);
                $("#stderr").html(json["stderr"]);
            }
            catch (error)
            {
                console.error(error);
            }
        }
        var dragging_handle = false;
        const handle = $(".handle");
        handle.on("mousedown", mouse_event => {
            if (dragging_handle || mouse_event.button != 0)
            {
                return;
            }
            dragging_handle = true;
            $("body").addClass("no-select");
        });
        document.onmouseup = mouse_event => {
            if (!dragging_handle || mouse_event.button != 0)
            {
                return;
            }
            dragging_handle = false;
            $("body").removeClass("no-select");
        };
        document.onmousemove = mouse_event => {
            if (!dragging_handle)
            {
                return;
            }
            mouse_event = mouse_event || window.event;
            const min_size = 300;
            if (horizontal_layout)
            {
                const mouse_position = Math.max(min_size, Math.min(window.innerWidth - min_size, mouse_event.clientX));
                handle_ratio = (mouse_position - handle.width() * 0.5) / (window.innerWidth - handle.width());
            }
            else
            {
                const mouse_position = Math.max(min_size, Math.min($("#main-split").height() - min_size, mouse_event.clientY - $("#main-split").position().top));
                handle_ratio = (mouse_position - handle.height() * 0.5) / ($("#main-split").height() - handle.height());
            }
            onResize();
        };
    </script>
</body>
</html>

