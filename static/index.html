<!DOCTYPE html>
<html>
<head>
    <title>GDScript.Live</title>
    <style>
    </style>
    <link rel="stylesheet" href="/static/main.css" />
    <link rel="stylesheet" href="/static/colors.css" />
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="/static/node_modules/monaco-editor/min/vs/editor/editor.main.css" />
    <script>
        var require = { paths: { vs: '/static/node_modules/monaco-editor/min/vs' } };
    </script>
    <script src="/static/node_modules/monaco-editor/min/vs/loader.js"></script>
    <script src="/static/node_modules/monaco-editor/min/vs/editor/editor.main.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
        crossorigin="anonymous"></script>
</head>
<body>
    <div class="header">
        <h1>GDScript.Live</h1>
        <p>Currently under development</p>
    </div>
    <div class="flex-h" id="main-split">
        <div id="code-editor" class="split-section"></div>
        <div class="handle">
            <div class="handle-dot"></div>
            <div class="handle-dot"></div>
            <div class="handle-dot"></div>
        </div>
        <div id="control-panel" class="flex-v split-section">
            <div class="flex-h">
                <label for="godot-version">Godot Version:</label>
                <select name="godot-version" id="godot-version">
                </select>
                <input id="run-button" type="button" value="Run" onclick="runScript()" />
            </div>
            <div id="script-results" class="flex-v">
                <label for="stdout">stdout:</label><br/>
                <textarea id="stdout" name="stdout" readonly></textarea><br/>
                <label for="stderr">stderr:</label><br/>
                <textarea id="stderr" name="stderr" readonly></textarea>
            </div>
        </div>
    </div>

    <script>
        const editor = monaco.editor.create($("#code-editor")[0], {
            value: ['function x() {', '\tconsole.log("Hello world!");', '}'].join('\n'),
            language: 'javascript',
            automaticLayout: true
        });
        // TODO: add syntax highlighting for monaco (likely with monarch)
    </script>
    <script>
        var handle_ratio = 0.5;
        var horizontal_layout = true;
        function onResize() {
            const aspect = window.innerWidth / window.innerHeight;
            if (aspect > 1.5)
            {
                //$("#main-split").removeClass("flex-v").addClass("flex-h");
                //$("#main-split.flex-h>*").width("");
                $("#main-split.flex-h>.handle").css("width", "");
                horizontal_layout = true
            }
            else if (aspect < 0.6)
            {
                //$("#main-split").removeClass("flex-h").addClass("flex-v");
                //$("#main-split.flex-v>*").height("");
                $("#main-split.flex-v>.handle").css("height", "");
                horizontal_layout = false;
            }
            const split_height = $("#main-split").height();
            const split_width = window.innerWidth;
            if (horizontal_layout)
            {
                //$("#main-split.flex-h>*").height(split_height);
                //$("#main-split.flex-h>.handle").css("height", `calc(${split_height}px - 2em`);
                $(".flex-h>#code-editor").width((window.innerWidth - 12) * handle_ratio);
            }
            else
            {
                //$("#main-split.flex-v>*").width(window.innerWidth);
                //$("#main-split.flex-v>.handle").css("width", `calc(${window.innerWidth}px - 2em`);
                $(".flex-v>#code-editor").height((split_height - 12) * handle_ratio);
            }
        }
        $(window).resize(onResize);
        onResize();

        async function updateVersionList() {
            try
            {
                const response = await fetch("/api/versions");
                if (!response.ok)
                {
                    throw new Error(`Response status: ${response.status}`);
                }
                const json = await response.json();
                const select = $("select#godot-version");
                select.empty();
                console.log(`Got JSON from /api/versions: ${json}`);
                for (const version of json["versions"])
                {
                    select.append(`<option value="${version}">${version}</option>`);
                }
            }
            catch (error)
            {
                console.error(error);
            }
        }
        updateVersionList();

        async function runScript() {
            console.log(editor.getValue());
            $("#stdout, #stderr").html("Running script...");
            try
            {
                const select = document.getElementById("godot-version");
                const response = await fetch(`/api/run?script=${btoa(editor.getValue())}&godot_version=${select.value}`);
                if (!response.ok)
                {
                    throw new Error(`Response status: ${response.status}`);
                }
                const json = await response.json();
                console.log(`Got JSON from /api/versions: ${json}`);
                $("#stdout").html(json["stdout"]);
                $("#stderr").html(json["stderr"]);
            }
            catch (error)
            {
                console.error(error);
            }
        }
        var dragging_handle = false;
        const handle = $(".handle");
        handle.on("mousedown", mouse_event => {
            if (dragging_handle || mouse_event.button != 0)
            {
                return;
            }
            dragging_handle = true;
            $("body").addClass("no-select");
        });
        document.onmouseup = mouse_event => {
            if (!dragging_handle || mouse_event.button != 0)
            {
                return;
            }
            dragging_handle = false;
            $("body").removeClass("no-select");
        };
        document.onmousemove = mouse_event => {
            if (!dragging_handle)
            {
                return;
            }
            mouse_event = mouse_event || window.event;
            const min_size = 300;
            if (horizontal_layout)
            {
                const mouse_position = Math.max(min_size, Math.min(window.innerWidth - min_size, mouse_event.clientX));
                handle_ratio = (mouse_position - handle.width() * 0.5) / (window.innerWidth - handle.width());
                //handle_ratio = Math.max(0.2, Math.min(0.8, handle_ratio));
            }
            else
            {
                const mouse_position = Math.max(min_size, Math.min($("#main-split").height() - min_size, mouse_event.clientY - $("#main-split").position().top));
                handle_ratio = (mouse_position - handle.height() * 0.5) / ($("#main-split").height() - handle.height());
            }
            console.log(`New ratio: ${handle_ratio}`);
            onResize();
        };
    </script>
</body>
</html>

